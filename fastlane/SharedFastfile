
ENV["FL_ENVIRONMENT_DIR"] = "Environment/"
ENV["FL_PROJECT_PLIST"] = "Source/Project-Info.plist"
ENV["SLACK_URL"] = "https://hooks.slack.com/services/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"
ENV["ACK_INHOUSE_MATCH_GIT"] = "git@gitlab.ack.ee:Ackee/ios-inhouse-certificates.git"
ENV["ACK_PRODUCTION_MATCH_GIT"] = "git@gitlab.ack.ee:Ackee/ios-production-certificates.git"
ENV["MATCH_GIT_URL"] = ENV["ACK_INHOUSE_MATCH_GIT"] # Default git is set to inhouse
ENV["FL_HOCKEY_API_TOKEN"] = "90fc8b51202f48bf9aa9772a7238f946"
ENV["ACK_ENTERPRISE_WILDCARD"] = "cz.ackee.enterprise.*"
ENV["MATCH_FORCE_ENTERPRISE"] = "1"
ENV["SIGH_OUTPUT_PATH"] = "outputs"

fastlane_version "1.57.0"

  #################################
  ###      Default lanes       ####
  #################################

  desc "Installs FixCode which disables the \"Fix Issue\" button in Xcode, Swimat and Fuzzy "
	lane :xcode do
	    install_xcode_plugin(
	      url: "https://github.com/fastlane/FixCode/releases/download/0.2.0/FixCode.xcplugin.zip"
	    )
      install_xcode_plugin(
        url: "https://s3-eu-west-1.amazonaws.com/ack-staticfiles/Swimat.xcplugin.zip"
      )
      
      install_xcode_plugin(
        url: "https://github.com/FuzzyAutocomplete/FuzzyAutocompletePlugin/releases/download/v2.1.1/FuzzyAutocomplete-2.1.1.zip"
      )
      templates
      snippets
  end


  desc "Runs linting (and eventually static analysis)"
  lane :analyze do
      #sh "utils/closure_leak_check.sh ../Source"
      swiftlint
  end

  desc "Runs unit, api and ui tests."
  lane :test do |options|
  	pod_install
  
    skip_slack = true
    open_report = true
    if is_ci?
      skip_slack = false
      open_report = false
    end

    if options[:type] == "api"
      scheme = "APITests"
    elsif options[:type] == "ui"
      scheme = "UITests"
    elsif options[:type] == "unit"
      scheme = "Development"
    else
      scheme = "AppStore"
    end

    scan(scheme:scheme, skip_slack: skip_slack, open_report: open_report)
  end

  desc "Create new screenshots for the App Store in all languages and device types"
  desc "Additionally, this will add device frames around the screenshots"
  lane :screenshots do
    snapshot(skip_open_summary: false)
    frameit(white: true)
  end

  desc "Copies and renames the project into new directory"
  lane :copy do |options|
    copy_project()
  end


  error do |lane, exception|
    if is_ci
      slack(
        message: exception.message,
        success: false
      )
    end
  end

  #################################
  ### Helper methods and lanes ####
  #################################

  ### Environment helpers ###

  def app_identifier(environment)
    get_environment_plist_value(key: "appIdentifier", environment:environment)
  end

  def app_name(environment)
    get_environment_plist_value(key: "appName", environment:environment)
  end

  def team_id(environment)
    get_environment_plist_value(key: "teamIdentifier", environment:environment)
  end

  
  
